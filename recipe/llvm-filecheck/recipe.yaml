context:
  version: "21.1.8"

package:
  name: llvm-filecheck
  version: ${{ version }}

source:
  url: https://github.com/llvm/llvm-project/releases/download/llvmorg-${{ version }}/llvm-project-${{ version }}.src.tar.xz
  sha256: 4633a23617fa31a3ea51242586ea7fb1da7140e426bd62fc164261fe036aa142

build:
  number: 0
  script:
    - if: unix
      then: |
        cmake -S llvm -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${PREFIX} \
          -DLLVM_TARGETS_TO_BUILD=host \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          -DLLVM_ENABLE_ASSERTIONS=OFF
        cmake --build build --target FileCheck --config Release
        install -d "${PREFIX}/bin"
        if [ -f "build/bin/FileCheck" ]; then cp build/bin/FileCheck "${PREFIX}/bin/"; fi
    - if: win
      then: |
        cmake -S llvm -B build -G Ninja ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_INSTALL_PREFIX=%LIBRARY_PREFIX% ^
          -DLLVM_TARGETS_TO_BUILD=host ^
          -DLLVM_INCLUDE_TESTS=OFF ^
          -DLLVM_INCLUDE_EXAMPLES=OFF ^
          -DLLVM_INCLUDE_BENCHMARKS=OFF ^
          -DLLVM_ENABLE_ASSERTIONS=OFF
        cmake --build build --target FileCheck --config Release
        if not exist "%LIBRARY_PREFIX%\bin" mkdir "%LIBRARY_PREFIX%\bin"
        set "FC_SRC="
        if exist "build\bin\FileCheck.exe" set "FC_SRC=build\bin\FileCheck.exe"
        if exist "build\bin\Release\FileCheck.exe" set "FC_SRC=build\bin\Release\FileCheck.exe"
        if exist "build\Release\bin\FileCheck.exe" set "FC_SRC=build\Release\bin\FileCheck.exe"
        if "%FC_SRC%"=="" (echo FileCheck.exe not found & exit /b 1)
        copy /Y "%FC_SRC%" "%LIBRARY_PREFIX%\bin\FileCheck.exe"

requirements:
  build:
    - ${{ compiler('cxx') }}
    - cmake
    - ninja
  host:
    - zlib
    - zstd
  run:
    - zlib
    - zstd

tests:
  - if: unix
    then:
      script: |
        FileCheck --version
        printf "hello\n" > input.txt
        printf "CHECK: hello\n" > check.txt
        FileCheck check.txt < input.txt
  - if: win
    then:
      script: |
        FileCheck --version
        echo hello> input.txt
        echo CHECK: hello> check.txt
        type input.txt | FileCheck check.txt

about:
  homepage: https://llvm.org/
  license: Apache-2.0 WITH LLVM-exception
  summary: LLVM FileCheck utility
  repository: https://github.com/llvm/llvm-project
